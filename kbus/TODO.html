<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.4.1: http://docutils.sourceforge.net/" />
<title>A crude to-do list</title>
<style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:Date: $Date: 2005-12-18 01:56:14 +0100 (Sun, 18 Dec 2005) $
:Revision: $Revision: 4224 $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

tt.docutils {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="a-crude-to-do-list">
<h1 class="title">A crude to-do list</h1>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">This TODO list is kept as a reStructuredText document.
If you are looking at an HTML file, then it is provided for your
convenience, and may not be up-to-date.</p>
</div>
<hr class="docutils" />
<div class="section">
<h1><a id="discussion-on-message-datastructure" name="discussion-on-message-datastructure">Discussion on message datastructure</a></h1>
<p>At the moment, the same datastructure is used for :</p>
<ol class="arabic simple">
<li>creating a new message in userspace and writing it to KBUS</li>
<li>reading a message from KBUS into userspace</li>
<li>storing/manipulating the message within KBUS itself.</li>
</ol>
<p>For the purposes of this discussion, the third can be ignored, as it is known
to be likely to change for all sorts of reasons, but also, importantly, since
KBUS needs to copy data between user and kernel space for both of the first
two, so conversion is not an issue.</p>
<p>Ideally, the message as send and the message as read use the same
datastructure.</p>
<p>Ideally, C shouldn't have to &quot;stuff&quot; a string into the message datastructure.
One &quot;solution&quot; to this is to use a message <em>code</em> instead of a message name.
That then raises the question of whether one only allows a message code in a
message, or if one still allows a string (which I personally prefer) how one
tells if the message is named or coded. Which tends to be icky.</p>
<p>In the future, it is believed that Richard will want to send messages with
large amounts of data. Copying said data into the message (in userspace) and
then out again (in kernel space) is at least one copy too many for comfort.</p>
<p>Lastly, the message size if variable, because it contains a message name and
optional data. This is a minor niggle, but still a niggle.</p>
<p>The alternative is to have a datastrucure with pointers out to the name and
data. I've tended to shy away from this, as it feels (to me) a little odd to
use <tt class="docutils literal"><span class="pre">write</span></tt> to write a datastructure containing pointers. Of course, I've
happily done exactly this with the ioctls for binding and umbinding, so that
is perhaps inconsistent.</p>
<p>What about reading? Since we're meant to use NEXTMSG to &quot;pop&quot; the next
message, and then <tt class="docutils literal"><span class="pre">read</span></tt> to read it, it feels to me as if that operation
should indeed read all of the data, into one place. But, as John points out,
this can be done:</p>
<pre class="literal-block">
Header data
ptr to name --------------+
ptr to data ---------+    +
name        &lt;--------|----+
...                  |
data        &lt;--------+
...
</pre>
<p>So, a proposal is to transform the message header into:</p>
<pre class="literal-block">
&lt;start guard&gt;
&lt;various header fields&gt;
name length
ptr to name
data length
ptr to data
&lt;end guard&gt;
</pre>
<p>The name length may never be less that 3 (&quot;$.x&quot;). The name pointer must thus
always be present.</p>
<p>The data length may be zero, in which case the ptr-to-data shall also be zero,
otherwise it shall not.</p>
<p>A special macro or function shall be supplied by the kernel header file to
<em>free</em> such a message. If the ptr-to-name is an &quot;internal&quot; pointer (see the
first diagram) then it doesn't need to free it. If the ptr-to-data is an
&quot;internal&quot; pointer, then it doesn't need to free it. It is quite likely that
these case would <em>also</em> be indicated by having some sort of flag in the
&quot;flags&quot; field.</p>
<p>Hmm. Presumably, a writer might want to reuse the same name for multiple
messages - they would presumably best <em>not</em> use this macro to free their
datastructure!</p>
<p>Given the above, <em>do</em> we need message codes? Since we're no longer copying the
message name all over the place externally? If we do, then it's probably
sufficient to set the name length to 0 and assert that this means that the
name pointer is now a name code.</p>
<blockquote>
(Message name length is <em>definitely</em> illegal, and is enforced as such now,
so this seems a reasonable &quot;escape clause&quot;. And we've now got a fixed size
datastructure, so we'd have the pointer field available anyway.)</blockquote>
<p>What about the end guard?</p>
<p>One of the nice things about the current (monolithic) message datastructure is
that the end guard sits, well, at the end of the (entire) message. Clearly in
our new (writable) datastructure, it sits after the ptr/length pairs, and
<em>not</em> after all of the other data. I'm not convinced this is a great problem,
though. Perhaps the &quot;all in one&quot; (first diagram) idea should include an extra
end guard after the end of the actual data, although I'm not convinced that
this makes sense.</p>
<hr class="docutils" />
<p>In no particular order (well, except for the first):</p>
<ul>
<li><p class="first">REQ Always, update documentation.</p>
</li>
<li><p class="first">REQ Make the comments in kbus.c and kbus.h follow the kernel documentation
rules.</p>
</li>
<li><p class="first">REQ Use &quot;const&quot; in an appropriate manner, throughout. Really.</p>
</li>
<li><p class="first">REQ Support blocking i/o</p>
</li>
<li><p class="first">REQ Improve the output in /proc/kbus/&lt;whatever&gt; so it is not limited to a
single page.</p>
</li>
<li><p class="first">OPT Ben suggested that I should be using mutexes instead of semaphores
(because that's now the way to do it). Which I take to refer to
<tt class="docutils literal"><span class="pre">linux/Documentation/mutex-design.txt</span></tt>. Look into it. It sounds sensible.</p>
</li>
<li><p class="first">OPT Make polling take account of urgent messages, so that (for instance) the
&quot;exception&quot; list in a <tt class="docutils literal"><span class="pre">select</span></tt> can detect them.</p>
</li>
<li><p class="first">OPT Internally, split messages into</p>
<blockquote>
<ul class="simple">
<li>header -- copy this between lists</li>
<li>message name/id -- if we're doing message name ids, then those should
be copied prefererentially</li>
<li>message data -- this should be reference counted</li>
</ul>
</blockquote>
</li>
<li><p class="first">REQ Large message support -- allow message data to be large, held as a list
of data split properly over pages. Really requires reference counting of
message data.</p>
</li>
<li><p class="first">REQ (LOW PRIORITY) Allow a KSock to say &quot;I am a network bridge&quot;, which means
that messages going over it might be hard to follow -- one might not be sure
if they've been delivered or not, and so it may be sensible to be able to
tell that a message has &quot;gone fuzzy&quot; -- sending to such an interface should
maybe set some status on the &quot;retval+status&quot; from a send.</p>
<p>Thus &quot;send&quot; should tell the caller as much as it can about how successful
it has been (including, if it can tell, that delivery has definitely worked
or failed).</p>
</li>
<li><p class="first">REQ (LOW PRIORITY) Provide a flag on file descriptors (hmm, perhaps better
on an individual message?) to say:</p>
<p>When I've sent a message, send me back a synthesised message when that
message has &quot;left the system&quot; -- i.e., when all listeners (that are going
to) have read it, when all repliers (that are going to) have replied to it,
and (if that isn't going to happen) when any exceptions regarding it have
been sent.</p>
<p>In other words, if the sender is remembering information about messages that
have been sent, this allows the sender to know that it can forget about the
message.</p>
</li>
</ul>
<hr class="docutils" />
<ul>
<li><p class="first">OPT Allow message name id to be used instead of message name in messages.
This would need:</p>
<blockquote>
<ul class="simple">
<li>ability to look up message name and retrieve its id</li>
<li>a way of indicating whether a message is storing message name (and
its length) or message name id</li>
<li>some better terminology for &quot;message name id&quot;</li>
</ul>
</blockquote>
<p>Note that in the Python interface this is not a big deal to the user.</p>
</li>
<li><p class="first">OPT Consider adding RESET functionality (the ioctl already exists):</p>
<ol class="arabic simple">
<li>Sends exactly one '$.KBUS.Reset.Start' message to each open interface
(so if one is listening and replying on an interface, one still only gets
a single such message on it).</li>
<li>Empties all of the queues -- this will generate any necessary synthetic
messages/exceptions relating to dropped requests/replies.</li>
<li>Resets all the internal ids (to start from 0 or 1 again).</li>
<li>Sends exactly one '$.KBUS.Reset.End' message to each open interface.</li>
</ol>
<p>Consideration: this would mean that all interfaces were automatically bound
to '$.KBUS.Reset.*'.</p>
<p>Use case: This would be useful for testing, and if we have multiple
interacting internal lists (for instance, message queues on each interface,
but also a list of outstanding requests), then it allows for a &quot;soft
restart&quot; other than removing and reinstalling the module.</p>
</li>
<li><p class="first">OPT Remove lots of the debugging 'printk's in <tt class="docutils literal"><span class="pre">kbus.c</span></tt> - there are way too
many.</p>
</li>
</ul>
<hr class="docutils" />
<ul>
<li><p class="first">DONE Implement sender ALL/WAIT flags:</p>
<ul class="simple">
<li>ALL_OR_WAIT -- add the message to all listener queues, and if that can't
be done because some queues are full, the sender should block on its SEND
until it can be done.</li>
<li>ALL_OR_FAIL -- add the message to all listener queues, and if that
can't be done, fail (the message is not sent).</li>
<li>(default) -- add the message to all listener queues that have room.</li>
</ul>
<p>Remember that, in this context, and interpreted appropriately, repliers also
count as listeners.</p>
</li>
<li><p class="first">DONE Support select/poll</p>
</li>
<li><p class="first">DONE Keep a spare slot in the receiver queue, to allow for receiving
asynchronous error messages.</p>
<p>Actually, a single slot is not enough.</p>
<p>One definitely needs to reserve a slot per Request sent, so that there is
guaranteed to be room for the Reply or (if something goes wrong) Status
message. It is this latter that makes the case - if KBus generates a Status
message (for a failed Request), then it <em>must</em> be able to add it to the
sender's message queue, otherwise KBus might block (we don't care if a
Replier blocks waiting on being able to send to the original sender, of
course).</p>
<p>So we need to keep a list of the Requests that a KSock has made, that have
not yet had a response, and not allow the KSock to SEND (technically, not to
allow it to SEND a Request, but that may be too complicated a condition)
until it has read enough to make that space. Of course, this does admit the
case where a sender can't send because it has run out of message queue,
absolutely, and is thus stuck pending a Reply arriving, but that's a
user-space hangup, so (in this sense) OK.</p>
<p>It's then questionable whether we also need to reserve an extra slot - I
think at the moment the only Status messages generated are those for failed
Requests.</p>
</li>
<li><p class="first">DONE Keep a list of all Requests that have not been replied to, and send the
sender a synthetic message when an interface has released, but has not
replied to a message, even though it <em>has</em> read it.</p>
</li>
</ul>
</div>
</div>
<div class="footer">
<hr class="footer" />
<a class="reference" href="TODO.txt">View document source</a>.
Generated on: 2009-04-21 12:29 UTC.
Generated by <a class="reference" href="http://docutils.sourceforge.net/">Docutils</a> from <a class="reference" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> source.

</div>
</body>
</html>
